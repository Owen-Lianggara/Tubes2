DROP TABLE IF EXISTS LOG_IOT;
DROP TABLE IF EXISTS Logs;
DROP TABLE IF EXISTS Unit;
DROP TABLE IF EXISTS Administrator;
DROP TABLE IF EXISTS Pengelola;
DROP TABLE IF EXISTS Pemilik;
DROP TABLE IF EXISTS Pengguna;
GO



-- PENGGUNA
CREATE TABLE Pengguna (
    NIK VARCHAR(16) PRIMARY KEY,
    No_Ponsel VARCHAR(15),
    Alamat_Domisili VARCHAR(100),
    TipeUser INT,
	Kondisi INT
    -- 0 = Pemilik, 1 = Administrator, 2 = Pengelola
);

-- SUBCLASS GENERALISASI
-- PEMILIK
CREATE TABLE Pemilik (
    NIK VARCHAR(16) PRIMARY KEY,
    FOREIGN KEY (NIK) REFERENCES Pengguna(NIK)
)
-- PENGELOLA
CREATE TABLE Pengelola (
    NIK VARCHAR(16) PRIMARY KEY,
    FOREIGN KEY (NIK) REFERENCES Pengguna(NIK)
)
-- ADMINSTRATOR
CREATE TABLE Administrator (
    NIK VARCHAR(16) PRIMARY KEY,
    FOREIGN KEY (NIK) REFERENCES Pengguna(NIK)
)

-- UNIT / SARUSUN
CREATE TABLE Unit (
    NomorUnitSarusun VARCHAR(10) PRIMARY KEY,
    LiterPerMenit DECIMAL(10,2),
    NoSerial VARCHAR(8),
    Akumulasi INT,
    UtilitasAirPerDetik DECIMAL(10,2),
    UtilitasAirHarian DECIMAL(10,2),
    UtilitasAirBulanan DECIMAL(10,2),
    UtilitasAirTahunan DECIMAL(10,2),
    NIK_Pengguna VARCHAR(16),
	kondisi INT,
    FOREIGN KEY (NIK_Pengguna) REFERENCES Pengguna(NIK)
);

-- LOG AKSI PADA UNIT
CREATE TABLE Logs (
    ID_log INT IDENTITY(1,1) PRIMARY KEY,
    Aksi INT, -- 0 = TUTUP, 1 = BUKA
    Waktu DATETIME,

	   NIK_Pengguna VARCHAR(16),
   FOREIGN KEY (NIK_Pengguna) REFERENCES Pengguna(NIK)
);

-- LOG AKSI IOT (oleh Pengelola)
CREATE TABLE LOG_IOT (
    ID_Aksi INT IDENTITY(1,1) PRIMARY KEY,
    Aksi INT, -- 0 = TUTUP, 1 = BUKA
	NomorUnitSarusun VARCHAR(10),
    WaktuAksi DATETIME,
	FOREIGN KEY (NomorUnitSarusun) REFERENCES Unit(NomorUnitSarusun)
    
    
);

INSERT INTO Pengguna (NIK, No_Ponsel, Alamat_Domisili, TipeUser, Kondisi) VALUES
('3201123456789011', '081234567890', 'Jl. Anggrek No. 5', 0, 1),
('3201123456789012', '082345678901', 'Jl. Mawar No. 2', 1, 1),
('3201123456789013', '083456789012', 'Jl. Melati No. 8', 2, 1);

-- DATA DUMMY UNIT
INSERT INTO Unit (NomorUnitSarusun, LiterPerMenit, NoSerial, Akumulasi, UtilitasAirPerDetik, UtilitasAirHarian, UtilitasAirBulanan, UtilitasAirTahunan, NIK_Pengguna, Kondisi) VALUES
('A0101', 15.00, 'SN100001', 500, 0.25, 120.00, 3600.00, 43800.00, '3201123456789011', 1),
('A0102', 15.50, 'SN100002', 520, 0.27, 125.00, 3700.00, 44000.00, NULL, 0),
('A0103', 16.00, 'SN100003', 530, 0.26, 122.00, 3650.00, 43900.00, NULL, 0),
('A0104', 14.80, 'SN100004', 510, 0.24, 118.00, 3550.00, 43500.00, NULL, 0),
('A0105', 15.20, 'SN100005', 525, 0.28, 130.00, 3750.00, 44200.00, NULL, 0),
('A0201', 15.10, 'SN100006', 540, 0.29, 132.00, 3780.00, 44300.00, NULL, 0),
('A0202', 15.30, 'SN100007', 550, 0.30, 135.00, 3800.00, 44500.00, NULL, 0),
('A0203', 14.90, 'SN100008', 545, 0.27, 127.00, 3680.00, 44100.00, NULL, 0),
('A0204', 15.60, 'SN100009', 560, 0.31, 138.00, 3850.00, 44800.00, NULL, 0),
('A0205', 15.40, 'SN100010', 565, 0.33, 140.00, 3900.00, 45000.00, NULL, 0),

('B0101', 16.10, 'SN100011', 570, 0.32, 142.00, 3920.00, 45100.00, NULL, 0),
('B0102', 16.30, 'SN100012', 575, 0.34, 145.00, 3950.00, 45200.00, '3201123456789012', 1),
('B0103', 16.50, 'SN100013', 580, 0.35, 147.00, 3980.00, 45300.00, NULL, 0),
('B0104', 16.20, 'SN100014', 585, 0.36, 150.00, 4000.00, 45500.00, NULL, 0),
('B0105', 16.40, 'SN100015', 590, 0.38, 155.00, 4050.00, 45800.00, NULL, 0),
('B0201', 16.60, 'SN100016', 595, 0.37, 153.00, 4020.00, 45600.00, NULL, 0),
('B0202', 16.70, 'SN100017', 600, 0.39, 158.00, 4100.00, 46000.00, NULL, 0),
('B0203', 16.80, 'SN100018', 605, 0.40, 160.00, 4150.00, 46200.00, NULL, 0),
('B0204', 16.90, 'SN100019', 610, 0.41, 162.00, 4200.00, 46400.00, NULL, 0),
('B0205', 17.00, 'SN100020', 615, 0.42, 165.00, 4250.00, 46600.00, NULL, 0)


-- DATA DUMMY LOGS (AKSI PENGGUNA)
INSERT INTO Logs (Aksi, Waktu, NIK_Pengguna) VALUES
(1, '2025-05-21 08:01:00', '3201123456789011'),
(0, '2025-05-21 10:05:00', '3201123456789012'),
(1, '2025-05-21 14:15:00', '3201123456789012'),
(0, '2025-05-21 16:45:00', '3201123456789011');

-- DATA DUMMY LOG_IOT (OLEH PENGELOLA UNTUK UNIT)
INSERT INTO LOG_IOT (Aksi, NomorUnitSarusun, WaktuAksi) VALUES
(1, 'A0101', '2025-05-21 08:02:00'),
(0, 'B0102', '2025-05-21 10:05:00');

SELECT * FROM Pengguna;
SELECT * FROM Unit;
SELECT * FROM Logs;
SELECT * FROM LOG_IOT;